###################################
## CODE DESCRIPTION IN USER FILES##
###################################

# -------------------------------- #
### Data cleanup and preparation ###
# -------------------------------- #
```{r Trust me run it}
# ----------- #
### Legend ###
# ----------- #
### 1. Libraries and Data
### 2. PRISM Imputation
### 3. Breast PRISM Imputation
### 4. Prism.cnv Breast
### 5. Select most efficient drugs
####### 5.1 Breast
####### 5.2 PRISM
### 6. Filtering non-oncology drugs
### 7. Variance treatment all cancer
### 8. TOP (x) MOA
####### 8.1 Breast
####### 8.2 PRISM
# ----------- #
#####################################
# 1. # IMPORT LIBRARIES & DATA ######
#####################################
library(ggplot2) #install.packages("ggplot2")
library(umap) #install.packages("umap")
library(readxl) #install.packages("readxl")
library(scales) #install.packages("scales")
library(dplyr)
#library(tidyverse) #install.packages("tidyverse")
# --------------------------------- #
load("/Users/luisherfurth/Codenmachtspass/Data/prism_datasets.rda")
load("/Users/luisherfurth/Codenmachtspass/Data/cellline_datasets.rda")
###############################
# 2. # PRISM IMPUTATION ####### Luis
###############################
p_onlyNA.col <- colnames(prism[which(sapply(prism, class) == "logical")]) 
rem.pNAcol <- which(colnames(prism) %in% p_onlyNA.col)
prismNA <- prism[, -rem.pNAcol]
prism_imp <- as.data.frame(apply(prismNA, 2, function(x) {
    is_na <- is.na(x)
    x[is_na] <- mean(x, na.rm = TRUE)
    return(x)
})) 

######################################
# 3. # BREAST PRISM IMPUTATION ####### Luis
######################################
breast_prism.cl <- prism.cl[which(prism.cl$lineage == 'breast'), ]
breast_prism <- prism[which(rownames(prism) %in% breast_prism.cl$DepMap_ID), ]
bp_onlyNA.col <- colnames(breast_prism[which(colSums(is.na(breast_prism)) == 22)]) 
rem.bpNAcol <- which(colnames(breast_prism) %in% bp_onlyNA.col)
breast_prism_imp <- breast_prism[, -rem.bpNAcol] 

breast_prism_imp <- as.data.frame(apply(breast_prism_imp, 2, function(x) {
    is_na <- is.na(x)
    x[is_na] <- mean(x, na.rm = TRUE)
    return(x)
}))
##############################
# 4. # PRISM.CNV BREAST ###### Simon
##############################
breast_prism.cl <- prism.cl[which(prism.cl$lineage == 'breast'), ]
ID_breast_prism.cl <- breast_prism.cl$DepMap_ID
rows_breast_prism.cnv <- which(rownames(prism.cnv) %in% ID_breast_prism.cl)
breast_prism.cnv <- prism.cnv[rows_breast_prism.cnv, ]
##############################
# 4. # PRISM.EXP BREAST ###### Sharu
##############################
lineage.breast <- prism.cl[which(prism.cl$lineage == "breast"),]
breast_prism.exp <- prism.exp[which(rownames(prism.exp) %in% lineage.breast$DepMap_ID),]
breastzero.col <- apply(breast_prism.exp, 2, function(x) all(x == 0))
breast_PRISM.exp <- breast_prism.exp[, !breastzero.col]
#############################
# 5. # PRISM.ACHILLES ####### Aaron
#############################
###########################
### IMPUTATION & BREAST ###
###########################
prism.achilles.rm <-apply(prism.achilles, 2, function(x) {
  x[which(is.na(x))] <- median(x, na.rm = TRUE)
  return(x)
})
prism.achilles.breast <- prism.achilles.rm[rownames(prism.achilles.rm) %in% breast_prism.cl, ]
################
### Overview ###
################
prism.achilles.mean <- apply(prism.achilles.rm, 2, mean)
prism.achilles.median <- apply(prism.achilles.rm, 2, median)
prism.achilles.sd <- apply(prism.achilles.rm, 2, sd)
prism.achilles.min <- apply(prism.achilles.rm, 2, min)
prism.achilles.max <- apply(prism.achilles.rm, 2, max)
prism.achilles.overview <- cbind(prism.achilles.mean, prism.achilles.median, prism.achilles.sd, prism.achilles.min, prism.achilles.max)
colnames(prism.achilles.overview) <- c("mean", "median", "standard deviation", "minimum", "maximum")
#########################################
# 5. # SELECT MOST EFFIZIENT DRUGS ###### Luis
#########################################
##############
### BREAST ###
##############
drugnames_b <- sub("::.*", "", colnames(breast_prism_imp))
concentration_b <- as.numeric(sub(".*::(.*?)::.*", "\\1", colnames(breast_prism_imp)))
names_conc_drug_b <- sub("::.*", "", sub("::", ":", colnames(breast_prism_imp)))
colMeans_breast <- apply(breast_prism_imp, 2, mean)
duplicate_drugs_b <- unique(drugnames_b[duplicated(drugnames_b)])
df_nam_con_mean_b <- data.frame(colMeans_breast, drugnames_b, concentration_b, names_conc_drug_b)
lowest_mean_duplicate_b <- data.frame()
for(i in 1:length(duplicate_drugs_b)) {
    act_rows_b <- which(df_nam_con_mean_b$drugnames_b == duplicate_drugs_b[i])
    act_df_b <- df_nam_con_mean_b[act_rows_b,]
    lowest_colmean_b <- min(act_df_b$colMeans_breast, na.rm = TRUE)
    lowest_mean_duplicate_b <- rbind(lowest_mean_duplicate_b, act_df_b[which(act_df_b$colMeans_breast == lowest_colmean_b),])
}
highest_mean_duplicate_b <- data.frame()
for(i in 1:length(duplicate_drugs_b)) {
    act_rows_b <- which(df_nam_con_mean_b$drugnames_b == duplicate_drugs_b[i])
    act_df_b <- df_nam_con_mean_b[act_rows_b,]
    highest_colmean_b <- max(act_df_b$colMeans_breast, na.rm = TRUE)
    highest_mean_duplicate_b <- rbind(highest_mean_duplicate_b , act_df_b[which(act_df_b$colMeans_breast == highest_colmean_b),])
}
pref_drug_con_combo_breast <- rownames(lowest_mean_duplicate_b)
breast_prism_lowest <- breast_prism_imp[,pref_drug_con_combo_breast]
lowest_mean_duplicate_tsh_b <- lowest_mean_duplicate_b[lowest_mean_duplicate_b$colMeans_breast < -2,]
pref_drug_ths_b <- rownames(lowest_mean_duplicate_tsh_b)
breast_prism_lowest_ths <- breast_prism_imp[,pref_drug_ths_b]
##############
### PRISM ####
##############
drugnames <- sub("::.*", "", colnames(prism_imp))
drugnames <- sub("::.*", "", colnames(prism_imp))
concentration <- as.numeric(sub(".*::(.*?)::.*", "\\1", colnames(prism_imp)))
names_conc_drug <- sub("::.*", "", sub("::", ":", colnames(prism_imp)))
colMeans <- apply(prism_imp, 2, mean)
duplicate_drugs <- unique(drugnames[duplicated(drugnames)])
df_nam_con_mean <- data.frame(colMeans, drugnames, concentration, names_conc_drug)
lowest_mean_duplicate <- data.frame()
for(i in 1:length(duplicate_drugs)) {
    act_rows <- which(df_nam_con_mean$drugnames == duplicate_drugs[i])
    act_df <- df_nam_con_mean[act_rows,]
    lowest_colmean <- min(act_df$colMeans, na.rm = TRUE)
    lowest_mean_duplicate <- rbind(lowest_mean_duplicate, act_df[which(act_df$colMeans == lowest_colmean),])
}
highest_mean_duplicate <- data.frame()
for(i in 1:length(duplicate_drugs)) {
    act_rows <- which(df_nam_con_mean$drugnames == duplicate_drugs[i])
    act_df <- df_nam_con_mean[act_rows,]
    highest_colmean <- max(act_df$colMeans, na.rm = TRUE)
    highest_mean_duplicate <- rbind(highest_mean_duplicate , act_df[which(act_df$colMeans == highest_colmean),])
}
pref_drug_con_combo <- rownames(lowest_mean_duplicate)
prism_lowest <- prism_imp[,pref_drug_con_combo]
lowest_mean_duplicate_tsh <- lowest_mean_duplicate[lowest_mean_duplicate$colMeans < -2,]
pref_drug_ths <- rownames(lowest_mean_duplicate_tsh)
prism_lowest_ths <- prism_imp[,pref_drug_ths]
##########################################
# 5. # FILTERING NON-ONCOLOGY DRUGS ###### Aaron
##########################################
cancer.therapy <- read_excel("/Users/luisherfurth/Codenmachtspass/Data/oncological_treatments.xlsx")
cancer.therapy <- as.data.frame(cancer.therapy)
treat.names <- as.data.frame(prism.treat$name)
drug.overlap <- apply(treat.names, 1, function(x){
  sum(cancer.therapy == x)
})
non.onco.treat <- prism.treat[-which(drug.overlap > 0),]
non.onco.treat <- non.onco.treat[-which("oncology" == non.onco.treat$disease.area),]
###########################################
# 7. # VARIANCE TREATMENT ALL CANCER ###### Aaron
###########################################
lineages <- unique(prism.cl$lineage)
lineages <- as.data.frame(lineages)
lineages.distribution <- apply(lineages, 1, function(x) {
    sum(prism.cl$lineage%in%x)
    })
rel.cl <- as.data.frame(lineages[which(lineages.distribution >= 10), ])
prism_var <- apply(prism_lowest, 1, var)
prism_var <- as.data.frame(prism_var)
prism.var.mean <- apply(rel.cl, 1, function(x){
  DepMap_ID <- prism.cl$DepMap_ID[prism.cl$lineage%in%x]
  test <- which(rownames(prism_var)%in%DepMap_ID)
  mean(prism_var[test,])
})
prism.var.mean <- as.data.frame(prism.var.mean)
names(prism.var.mean) <- "mean_of_variance"
number_of_cellines <- lineages.distribution[lineages.distribution >= 10]
prism.var.mean$Number_of_cellines <- number_of_cellines
########################################
# 8. # FACTOR FOR THE TOP (X) MOA ###### Luis
########################################
##############
### BREAST ###
##############
meta_eff_treat_b <- prism.treat[pref_drug_con_combo_breast,]
level_counts_b <- table(meta_eff_treat_b$moa)
sorted_levels_b <- names(sort(level_counts_b, decreasing = TRUE))
top_x_levels_b <- sorted_levels_b[1:20] ### <---! USER INPUT --->
levels_b <- factor(meta_eff_treat_b$moa, levels = c("Other", top_x_levels_b))
meta_eff_treat_b$levels_b <- levels_b
meta_eff_treat_b$levels_b[is.na(meta_eff_treat_b$levels_b)] <- "Other"
level_colors_b <- rainbow(length(top_x_levels_b))
color_palette_b <- c(setNames(level_colors_b, top_x_levels_b), Other = "transparent")
#############
### PRISM ###
#############
meta_eff_treat <- prism.treat[pref_drug_con_combo,]
level_counts <- table(meta_eff_treat$moa)
sorted_levels <- names(sort(level_counts, decreasing = TRUE))
top_x_levels <- sorted_levels[1:20]  ### <---! USER INPUT --->
levels <- factor(meta_eff_treat$moa, levels = c("Other", top_x_levels))
meta_eff_treat$levels <- levels
meta_eff_treat$levels[is.na(meta_eff_treat$levels)] <- "Other"
level_colors <- rainbow(length(top_x_levels))
color_palette <- c(setNames(level_colors, top_x_levels), Other = "lightgray")
################ Sharu
#PRISM.snv.breast <- prism.snv[which(as.character(prism.snv$DepMap_ID) %in% breast_prism.cl$DepMap_ID),]
#prism.snv.breast <- PRISM.snv.breast[PRISM.snv.breast$Variant_Classification != "Silent",]
#prism.snv.breast_damage <- prism.snv.breast[prism.snv.breast$Variant_annotation == "damaging",]
##
#missingrows.achilles <- matrix(0, nrow = 5, ncol = ncol(prism.achilles.breast))
#colnames(missingrows.achilles) <- colnames(prism.achilles.breast)
#rownames(missingrows.achilles) <- setdiff(rownames(breast_prism.exp), rownames(prism.achilles.breast))[1:5]
#breast_prism.achilles <- rbind(prism.achilles.breast, missingrows.achilles)
#
#damage.exp <- breast_prism.exp[,colnames(breast_prism.exp) %in% prism.snv.breast_damage$Hugo_Symbol]
#exp.sorted_col <- colnames(damage.exp)[order(colnames(damage.exp))]
#breast_damage.exp <- damage.exp[, exp.sorted_col]
##
#damage.cnv <- breast_prism.cnv[,colnames(breast_prism.achilles) %in% prism.snv.breast_damage$Hugo_Symbol]
#cnv.sorted_col <- colnames(damage.cnv)[order(colnames(damage.cnv))]
#breast_damage.cnv <- damage.cnv[, cnv.sorted_col]
##
#breast_damage.achilles <- as.data.frame(breast_prism.achilles[,colnames(breast_prism.achilles) %in% prism.snv.breast_damage$Hugo_Symbol])
#damage.achilles_mean <- apply(breast_damage.achilles, 2, mean)
##
#important_genes <- colnames(breast_damage.achilles[,which(damage.achilles_mean <= -0.5)])
#important_gene_exp <- prism.exp[, colnames(prism.exp) %in% important_genes]
#important_gene_list <- colnames(important_gene_exp)
##
#carcinoma_damage.achilles <- as.data.frame(breast_prism.achilles[rownames(prism.achilles.breast_carcinoma),colnames(breast_prism.achilles) %in% prism.snv.breast_damage$Hugo_Symbol])
#arcinoma.damage.achilles_mean <- apply(carcinoma_damage.achilles, 2, mean)
##
#important_carcinoma.genes <- colnames(carcinoma_damage.achilles[,which(carcinoma.damage.achilles_mean <= -0.5)])
#important_carcinoma.gene_exp <- prism.exp[, colnames(prism.exp) %in% important_carcinoma.genes]
#important_carcinoma.gene_list <- colnames(important_carcinoma.gene_exp)
#
#prism.snv.breast_carcinoma <- prism.snv.breast_damage[prism.snv.breast_damage$DepMap_ID %in% breast_carcinoma,]
#prism.snv.breast_ductal_carcinoma <- prism.snv.breast_damage[prism.snv.breast_damage$DepMap_ID %in% breast_ductal_carcinoma,]
```

# --------------------------- #
### Variables and their use ###
# --------------------------- #
```{r}
#############
# IMPORTANT #
#############
prism_imp #<--! prism with NA´s imputed -->
breast_prism_imp #<--! subset breast cancer with NA´s imputed -->
lowest_mean_duplicate #<--! drug, conc, colMean for the most effizient drugs -->
breast_prism_lowest #<--! most efficient drugs for breast cellines -->
# -> breast_prism_lowest_ths #<--! with threshold (threshold: -2) -->
prism_lowest #<--! most efficient drugs for all cellines -->
# ->prism_lowest_ths #<--! with threshold (threshold: -2) -->
prism.achilles.overview #<--! almost all celllines K.O. Score (min, max, mean, etc...) -->
prism.achilles.breast #<--! breast cancer celllines K.O. Score -->
################
# NICE TO HAVE #
################
meta_eff_treat_b #<--! meta data for most effizient drugs breast -->
meta_eff_treat #<--! same for all cellines -->
top_x_levels_b #<--! top x moa for breast -->
top_x_levels #<--! same all cellines -->
```

# -------------------------------------- #
### Basic statistics and Visualisation ###
# -------------------------------------- #
```{r}
################################
###### NA ANALYSIS #############
################################
sum(is.na(prism))
min(prism, na.rm = TRUE) ##-12.06536
max(prism, na.rm = TRUE) ##5.007653
hist(colMeans(is.na(prism[,-rem.pNAcol])), breaks = 100, xlab = "NA Anteil", main = "Histogramm der NA Anteile")
################################
###### CELL GROWTH BREAST ######
################################
vec_breast <- unlist(sapply(breast_prism, function(x) x[is.numeric(x)]))
vec_breast <- as.data.frame(na.omit(vec_breast))
hist(vec_breast, breaks = 80, xlab = "Cell Growth", main = "Overview of the Cell Growth", xlim = c(-8, 2));abline(v = mean(vec_breast, na.rm = TRUE), col = "red", lwd = 2, lty = 3);abline(v = median(vec_breast, na.rm = TRUE), col = "blue", lwd = 2, lty= 3);legend("topleft", legend = c("mean", "median"), col = c("red", "blue"), lwd = 2, lty = 3)
heatmapbreast <- pheatmap(breast_prism_imp, show_rownames = TRUE, show_colnames = FALSE)
##################################
###### CONCENTRATION EFFECT ######
##################################
hist(as.numeric(lowest_mean_duplicate_b$concentration_b))
hist(lowest_mean_duplicate_b$colMeans_breast)
hist(as.numeric(highest_mean_duplicate_b$concentration_b))
hist(highest_mean_duplicate_b$colMeans_breast)
#################################
###### DIMENSION REDUCTION ######
#################################
############
### UMAP ###
############
# ------
# BREAST
breast_cancer_umap <- umap(t(breast_prism_lowest), n_neighbors = 7, min_dist = 0.5, n_epochs = 200, n_components = 2) 
umap_layout_breast <- as.data.frame(breast_cancer_umap$layout)

umap_layout_breast$levels_b <- meta_eff_treat_b$levels_b

umap_layout_breast <- umap_layout_breast %>%
  mutate(alpha_level_b = ifelse(levels_b == "Other", 0.2, 1))

color_palette_b <- c(setNames(level_colors, top_x_levels), Other = "lightgray")

ggplot(umap_layout_breast, aes(x = V1, y = V2, color = levels_b, alpha = alpha_level_b)) +
    geom_point(size = 3) +
    scale_color_manual(values = color_palette_b) +
    theme_bw() +
    ggtitle("UMAP of the Breastcancer celllines")
# ------
# PRISM
cancer_umap <- umap(t(prism_lowest), n_neighbors = 7, min_dist = 0.5, n_epochs = 200, n_components = 2) 
umap_layout_prism <- as.data.frame(cancer_umap$layout)

umap_layout_prism$levels <- meta_eff_treat$levels

umap_layout_prism <- umap_layout_prism %>%
  mutate(alpha_level = ifelse(levels == "Other", 0.2, 1))

color_palette <- c(setNames(level_colors_b, top_x_levels_b), Other = "lightgray")

ggplot(umap_layout_prism, aes(x = V1, y = V2, color = levels, alpha = alpha_level)) +
    geom_point(size = 3) +
    scale_color_manual(values = color_palette) +
    theme_bw() +
    ggtitle("UMAP of all celllines")
# -----
#################################
###### Lineare Regression #######
#################################
# ------
special_drugs <- rownames(lowest_mean_duplicate_b[which(lowest_mean_duplicate_b$colMeans_breast < -2 & lowest_mean_duplicate_b$concentration_b < 1),])
special_drugs_meta <- meta_eff_treat_b[which(rownames(meta_eff_treat_b) %in% special_drugs),]
special_drugs_meta[,1:6]
special_drugs_meta[,7:12]
# ------ 
high_conc <- rownames(prism.treat[which(prism.treat$dose > 9),])
high_conc_breast <- breast_prism_imp[,which(colnames(breast_prism_imp) %in% high_conc)]
col_mean_high_conc <- apply(high_conc_breast, 2, mean)
# vvvvvvvv #
hist(col_mean_high_conc) # <---! distribution of the mean of the high concentration drugs -->
# ------
conc_tsh_b <- df_nam_con_mean_b$concentration_b[which(df_nam_con_mean_b$colMeans < -2)]
colMeans_tsh_b <- df_nam_con_mean_b$colMeans_breast[which(df_nam_con_mean_b$colMeans < -2)]
model_breast_tsh <- lm(colMeans_tsh_b ~ conc_tsh_b, data = df_nam_con_mean_b)
# vvvvvvvv #
summary(model_breast_tsh)
plot(conc_tsh_b, colMeans_tsh_b) ; abline(model_breast_tsh, col = "red") # <---! linear regression of the inhibitory drugs -->
# ------
model_breast <- lm(concentration_b ~ colMeans_breast, data = df_nam_con_mean_b)
model_prism <- lm(concentration ~ colMeans, data = df_nam_con_mean)
# vvvvvvvv #
plot(colMeans_breast,concentration_b); abline(model_breast, col = "red")
plot(colMeans,concentration); abline(model_prism, col = "red")
summary(model_breast) # <---! linear regression of the drugs on breast-->
summary(model_prism) # <---! linear regression of the drugs on prism-->
```

```{r}
######################
### VISUALISATIONS ###
######################
library(ggplot2)

vec_breast <- unlist(sapply(breast_prism, function(x) x[is.numeric(x)]))
vec_breast <- na.omit(vec_breast)
inhibitory <- vec_breast < -2
ggplot() +
    geom_histogram(aes(x = vec_breast, fill = inhibitory), bins = 111) +
    scale_fill_manual(values = c("coral2", "steelblue2")) +
    labs(title = "Cell Growth of breast cancer cells after treatment", x = "log2FC", y = "Count")
################
high_cor <- highest_cor_b$correlation < -0.9
ggplot() +
    geom_histogram(aes(x = highest_cor_b$correlation, fill = high_cor), bins = 121) +
    scale_fill_manual(values = c("coral2", "steelblue2"))
################


```
## Testing
```{r}
#### Determine correlation between drugs and concentration ####
drugnames_b <- sub("::.*", "", colnames(breast_prism_imp))
concentration_b <- as.numeric(sub(".*::(.*?)::.*", "\\1", colnames(breast_prism_imp)))
names_conc_drug_b <- sub("::.*", "", sub("::", ":", colnames(breast_prism_imp)))
colMeans_breast <- apply(breast_prism_imp, 2, mean)
duplicate_drugs_b <- unique(drugnames)
df_nam_con_mean_b <- data.frame(colMeans_breast, drugnames_b, concentration_b, names_conc_drug_b)
highest_cor_b <- data.frame()
for(i in 1:length(duplicate_drugs_b)) {
    act_rows_b <- which(df_nam_con_mean_b$drugnames_b == duplicate_drugs_b[i])
    act_df_b <- df_nam_con_mean_b[act_rows_b,]
    if (length(act_rows_b) > 2) {
        cor_b <- cor(act_df_b$concentration_b, act_df_b$colMeans_breast, method = "pearson")
        new_row <- data.frame(drugname = duplicate_drugs_b[i], correlation = cor_b)
        highest_cor_b <- rbind(highest_cor_b, new_row)
    }
}
#### Visualize the correlations ####
ggplot() +
    geom_histogram(aes(x = highest_cor_b$correlation), fill = "steelblue", bins = 150) 

#### Select high correlation drugs ####
low_cor_b <- highest_cor_b[which(highest_cor_b$correlation < - 0.9),]
low_cor_drug_b <- low_cor_b$drugname

#### Linear regression of the high correlation drugs ####
df_nam_con_mean_b[which(low_cor_drug_b %in% df_nam_con_mean_b$drugnames_b),]
colme_low_cor_b <- df_nam_con_mean_b$colMeans_breast[which(low_cor_drug_b %in% df_nam_con_mean_b$drugnames_b)]
conc_low_cor_b <- df_nam_con_mean_b$concentration_b[which(low_cor_drug_b %in% df_nam_con_mean_b$drugnames_b)]

cor_model <- lm(colme_low_cor_b ~ conc_low_cor_b, data = df_nam_con_mean_b)
summary(cor_model)

plot(conc_low_cor_b, colme_low_cor_b); abline(cor_model, col = "red")

#### drugs with correlation -1 ####
min(highest_cor_b$correlation)
df_nam_con_mean_b[which(highest_cor_b$drugname[which(highest_cor_b$correlation == min(highest_cor_b$correlation))] %in% df_nam_con_mean_b$drugnames_b),]
```

