```{r}
load("C:/Users/aaron/Desktop/Studium/4. Semester/Bioinfo/prism_datasets.rda")
load("C:/Users/aaron/Desktop/Studium/4. Semester/Bioinfo/cellline_datasets.rda")

```



How about a kmeans clustering? 

(cell lines)
```{r}
wss.prism <- sapply(1:10, function(x) kmeans(breast_prism_imp, x)$tot.withinss)

plot(1:10, wss.prism, type = "b", xlab = "N of clusters", ylab = "Total within sum of square")

```

(treaments)
```{r}
wss.prism <- sapply(1:10, function(x) kmeans(t(breast_prism_lowest), x)$tot.withinss)

plot(1:10, wss.prism, type = "b", xlab = "N of clusters", ylab = "Total within sum of square")

```
not very helpful...

As a diferent way to look at the amounts of clusters. silhouette plots.
(cell lines)
```{r}
prism.sd <- apply(breast_prism_imp, 2, sd)

prism.rel <- breast_prism_imp[, which(prism.sd>1)]

D <- dist(t(prism.rel))
library(cluster)
sil <- vector()

for (k in 1:60) {
  km <- kmeans(x = t(prism.rel), centers = k, iter.max = 40)
  s <- silhouette(km$cluster, D)
  sil <- c(sil, mean(s))
}
plot(1:60,sil)
```
(treatments)
```{r}
D <- dist(t(breast_prism_lowest))
library(cluster)
sil <- vector()

for (k in 1:20) {
  km <- kmeans(x = t(breast_prism_lowest), centers = k, iter.max = 40)
  s <- silhouette(km$cluster, D)
  sil <- c(sil, mean(s))
}
plot(1:20,sil)
```


The maximal QTR stage has been exceeded. This means we have to reduce the data.

```{r} 
#trying to do the clustering on the whole prism data
wss.prism <- sapply(1:10, function(x) kmeans(t(prism_imp), x)$tot.withinss)

plot(1:10, wss.prism, type = "b", xlab = "N of clusters", ylab = "Total within sum of square")



```

This needs too much computational power



```{r}
#try to identify the treatments with low sd

prism.sd <- apply(breast_prism_imp, 2, sd)

prism.rel <- breast_prism_imp[, which(prism.sd>1.5)]# relevant treatments

wss.prism <- sapply(1:10, function(x) kmeans(breast_prism_imp, x)$tot.withinss)

plot(1:10, wss.prism, type = "b", xlab = "N of clusters", ylab = "Total within sum of square")
```




Now I will try something. I want to know drugs that show a high effect on some cell lines. For this I will firstly delete the columns of oncological drugs as there were shown to have a effect on cancer
```{r}

lowest_cl <- colnames(breast_prism_imp)%in%rownames(lowest_mean_duplicate)
breast_prism_lowest <- breast_prism_imp[,lowest_cl]
#breast_prism_lowest has now only the cell lines from lowest_mean_duplicate
dim(breast_prism_lowest)
lowest_cl_prism <- colnames(prism_imp)%in%rownames(lowest_mean_duplicate)
prism_lowest <- prism_imp[,lowest_cl_prism]
```

```{r}
sum(is.na(prism.treat$disease.area))/dim(prism.treat)[1]
#This means 64,7% of disease areas are unknown


sum(na.omit("oncology"==prism.treat$disease.area))/dim(prism.treat)[1]
```
As not every drug has a specific disease area, we will try to eliminate the oncological drugs via their names.For this we will compare the drugs in prism.treat and in two cancer treatment list, cancer national institute (https://www.cancer.gov/about-cancer/treatment/drugs) and cancer research UK (https://www.cancerresearchuk.org/about-cancer/treatment/drugs) 
```{r}
library(readxl)
cancer.therapy <- read_excel("C:/Users/aaron/Desktop/Studium/4. Semester/Bioinfo/oncological_treatments.xlsx")
cancer.therapy <- as.data.frame(cancer.therapy)
treat.names <- as.data.frame(prism.treat$name)


drug.overlap <- apply(treat.names, 1, function(x){
  sum(cancer.therapy==x)
})
which(drug.overlap>0)

non.onco.treat <- prism.treat[-which(drug.overlap>0),]
non.onco.treat <- non.onco.treat[-which("oncology"==non.onco.treat$disease.area),]
dim(non.onco.treat)[1]/dim(prism.treat)[1]
#The data frame "non.onco.treat" is now the same as prism.treat but without known oncological drugs

```

```{r}
non_onco_prism <- prism_lowest[,colnames(prism_lowest)%in%rownames(non.onco.treat)]

                              
```



Now we will look at which group of cancers has the highest variance in their treatment response. This will help with the Dimension reduction and the clustering.
```{r}

lineages <- unique(prism.cl$lineage)
lineages <- as.data.frame(lineages)
lineages.distribution <- apply(lineages, 1, function(x) {
  sum(prism.cl$lineage%in%x)
})
rel.cl <- as.data.frame(lineages[which(lineages.distribution >= 10), ])
prism.all.var <- apply(prism_lowest, 1, var)
prism.all.var <- as.data.frame(prism.all.var)


```

In "prism.all.var are now the variances of all rows of "prism_lowest". Now we will create a data frame that contains the means of the variances of all the lineage with more than 9 cell lines. 

```{r}
prism.var.mean <- apply(rel.cl, 1, function(x){
  DepMap_ID <- prism.cl$DepMap_ID[prism.cl$lineage%in%x]
  test <- c(which(rownames(prism.all.var)%in%DepMap_ID))
  mean(prism.all.var[test,])
})
prism.var.mean <- as.data.frame(prism.var.mean)
rownames(prism.var.mean) <- as.character(rel.cl[,1])

lineage.amount <- lineages.distribution[which(lineages.distribution >= 10)]
prism.var.mean$LineageAmount <- lineage.amount
colnames(prism.var.mean)[1] <- "VarMeans"
View(prism.var.mean)

```


How about we make a data frame with only the treatments with high variance so that the dimension reduction is easier.
```{r}
treat.var <- apply(prism_lowest, 2, var)

rel.treat <- prism_lowest[,treat.var>=1]

```




We test whether there are differences in the prism scores between oncological and non-oncological drugs.

```{r}
onco.all.treat <- prism.treat[which(drug.overlap>0),]

onco.treat <- prism.treat[which("oncology"==prism.treat$disease.area),]

all_onco_prism <- prism_lowest[,colnames(prism_lowest)%in%rownames(onco.all.treat)]

onco_prism <- prism_lowest[,colnames(prism_lowest)%in%rownames(onco.treat)]

non.onco.mean <- apply(non_onco_prism, 2, mean)

all.onco.mean <- apply(all_onco_prism, 2, mean)

onco.mean <- apply(onco_prism, 2, mean)

prism.mean <- apply(prism_lowest, 2, mean)

non.onco.var <- apply(non_onco_prism, 2, var)

onco.var <- apply(onco_prism, 2, var)

mean(onco.var)
mean(non.onco.var)

hist(onco.mean)
hist(all.onco.mean)
hist(non.onco.mean)
hist(prism.mean)
```


trying to calculate the correlation between treatment response and gene expression. I'm very unsure if this will work in any way but here we go...

```{r}
exp.treat.cor <- data.frame()  

for (y in 1:ncol(breast_prism_lowest)) {
  correlation <- c()
  
  for (x in 1:ncol(breast_PRISM.exp)) {
    gene.expression <- breast_PRISM.exp[, x]
    correlation[x] <- cor(breast_prism_lowest[, y], gene.expression)
  }
  
  
  
  if (y == 1) {
    exp.treat.cor <- correlation  
  } else {
    exp.treat.cor <- cbind(exp.treat.cor, correlation)  
  }
}
#colnames(exp.treat.cor) <- colnames(breast_prism_lowest)
#rownames(exp.treat.cor) <- colnames(breast_PRISM.exp)
```




```{r}
rownames(breast_prism.cnv)%in%rownames(breast_prism.exp)
rownames(prism.exp[which(rownames(prism.exp)%in%rownames(prism.achilles)),])%in%rownames(prism.cnv)

```











```{r}
#junkyard
exp.treat.cor <- data.frame()
for (y in range(1:ncol(breast_prism_lowest))){
  for (x in range(1:ncol(breast_PRISM.exp))){
    gene.expression <- breast_PRISM.exp[,x]
    correlation[x] <- cor(breast_prism_lowest[,y], gene.expression)
  }
  exp.treat.cor <- gene_expression
}

exp.treat.cor <- data.frame()

for (y in 1:50) {
  correlation <- c()
  
  for (x in 1:50) {
    gene.expression <- breast_PRISM.exp[, x]
    correlation[x] <- cor(breast_prism_lowest[, y], gene.expression)
  }
  
  result <- data.frame(Treatment_Column = names(breast_prism_lowest)[y], Correlation = correlation)
  exp.treat.cor <- cbind(exp.treat.cor, result)
}

for (x in range(1:ncol(breast_PRISM.exp))){
  gene.expression <- breast_PRISM.exp[,x]
  correlation[x] <- cor(breast_prism_lowest[,1], gene.expression)
}
  
```


