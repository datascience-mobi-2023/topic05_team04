```{r}
load("C:/Users/aaron/Desktop/Studium/4. Semester/Bioinfo/prism_datasets.rda")
load("C:/Users/aaron/Desktop/Studium/4. Semester/Bioinfo/cellline_datasets.rda")

```



How about a kmeans clustering? 

(cell lines)
```{r}
wss.prism <- sapply(1:10, function(x) kmeans(breast_prism_imp, x)$tot.withinss)

plot(1:10, wss.prism, type = "b", xlab = "N of clusters", ylab = "Total within sum of square")

```

(treaments)
```{r}
wss.prism <- sapply(1:10, function(x) kmeans(t(breast_prism_lowest), x)$tot.withinss)

plot(1:10, wss.prism, type = "b", xlab = "N of clusters", ylab = "Total within sum of square")

```
not very helpful...

As a diferent way to look at the amounts of clusters. silhouette plots.
(cell lines)
```{r}
prism.sd <- apply(breast_prism_imp, 2, sd)

prism.rel <- breast_prism_imp[, which(prism.sd>1)]

D <- dist(t(prism.rel))
library(cluster)
sil <- vector()

for (k in 1:60) {
  km <- kmeans(x = t(prism.rel), centers = k, iter.max = 40)
  s <- silhouette(km$cluster, D)
  sil <- c(sil, mean(s))
}
plot(1:60,sil)
```
(treatments)
```{r}
D <- dist(t(breast_prism_lowest))
library(cluster)
sil <- vector()

for (k in 1:20) {
  km <- kmeans(x = t(breast_prism_lowest), centers = k, iter.max = 40)
  s <- silhouette(km$cluster, D)
  sil <- c(sil, mean(s))
}
plot(1:20,sil)
```


The maximal QTR stage has been exceeded. This means we have to reduce the data.

```{r} 
#trying to do the clustering on the whole prism data
wss.prism <- sapply(1:10, function(x) kmeans(t(prism_imp), x)$tot.withinss)

plot(1:10, wss.prism, type = "b", xlab = "N of clusters", ylab = "Total within sum of square")



```

This needs too much computational power



```{r}
#try to identify the treatments with low sd

prism.sd <- apply(breast_prism_imp, 2, sd)

prism.rel <- breast_prism_imp[, which(prism.sd>1.5)]# relevant treatments

wss.prism <- sapply(1:10, function(x) kmeans(breast_prism_imp, x)$tot.withinss)

plot(1:10, wss.prism, type = "b", xlab = "N of clusters", ylab = "Total within sum of square")
```




Now I will try something. I want to know drugs that show a high effect on some cell lines. For this I will firstly delete the columns of oncological drugs as there were shown to have a effect on cancer
```{r}

lowest_cl <- colnames(breast_prism_imp)%in%rownames(lowest_mean_duplicate)
breast_prism_lowest <- breast_prism_imp[,lowest_cl]
#breast_prism_lowest has now only the cell lines from lowest_mean_duplicate
dim(breast_prism_lowest)
lowest_cl_prism <- colnames(prism_imp)%in%rownames(lowest_mean_duplicate)
prism_lowest <- prism_imp[,lowest_cl_prism]
```

```{r}
sum(is.na(prism.treat$disease.area))/dim(prism.treat)[1]
#This means 64,7% of disease areas are unknown


sum(na.omit("oncology"==prism.treat$disease.area))/dim(prism.treat)[1]
```
As not every drug has a specific disease area, we will try to eliminate the oncological drugs via their names.For this we will compare the drugs in prism.treat and in two cancer treatment list, cancer national institute (https://www.cancer.gov/about-cancer/treatment/drugs) and cancer research UK (https://www.cancerresearchuk.org/about-cancer/treatment/drugs) 
```{r}
library(readxl)
cancer.therapy <- read_excel("C:/Users/aaron/Desktop/Studium/4. Semester/Bioinfo/oncological_treatments.xlsx")
cancer.therapy <- as.data.frame(cancer.therapy)
treat.names <- as.data.frame(prism.treat$name)


drug.overlap <- apply(treat.names, 1, function(x){
  sum(cancer.therapy==x)
})
which(drug.overlap>0)

non.onco.treat <- prism.treat[-which(drug.overlap>0),]
non.onco.treat <- non.onco.treat[-which("oncology"==non.onco.treat$disease.area),]
dim(non.onco.treat)[1]/dim(prism.treat)[1]
#The data frame "non.onco.treat" is now the same as prism.treat but without known oncological drugs

```

```{r}
non_onco_prism <- prism_lowest[,colnames(prism_lowest)%in%rownames(non.onco.treat)]

                              
```



Now we will look at which group of cancers has the highest variance in their treatment response. This will help with the Dimension reduction and the clustering.
```{r}

lineages <- unique(prism.cl$lineage)
lineages <- as.data.frame(lineages)
lineages.distribution <- apply(lineages, 1, function(x) {
  sum(prism.cl$lineage%in%x)
})
rel.cl <- as.data.frame(lineages[which(lineages.distribution >= 10), ])
prism.all.var <- apply(prism_lowest, 1, var)
prism.all.var <- as.data.frame(prism.all.var)


```

In "prism.all.var are now the variances of all rows of "prism_lowest". Now we will create a data frame that contains the means of the variances of all the lineage with more than 9 cell lines. 

```{r}
prism.var.mean <- apply(rel.cl, 1, function(x){
  DepMap_ID <- prism.cl$DepMap_ID[prism.cl$lineage%in%x]
  test <- c(which(rownames(prism.all.var)%in%DepMap_ID))
  mean(prism.all.var[test,])
})
prism.var.mean <- as.data.frame(prism.var.mean)
rownames(prism.var.mean) <- as.character(rel.cl[,1])

lineage.amount <- lineages.distribution[which(lineages.distribution >= 10)]
prism.var.mean$LineageAmount <- lineage.amount
colnames(prism.var.mean)[1] <- "VarMeans"
#View(prism.var.mean)

```


How about we make a data frame with only the treatments with high variance so that the dimension reduction is easier.
```{r}
treat.var <- apply(prism_lowest, 2, var)

rel.treat <- prism_lowest[,treat.var>=1]

```




We test whether there are differences in the prism scores between oncological and non-oncological drugs.

```{r}
onco.all.treat <- prism.treat[which(drug.overlap>0),]

onco.treat <- prism.treat[which("oncology"==prism.treat$disease.area),]

all_onco_prism <- prism_lowest[,colnames(prism_lowest)%in%rownames(onco.all.treat)]

onco_prism <- prism_lowest[,colnames(prism_lowest)%in%rownames(onco.treat)]

non.onco.mean <- apply(non_onco_prism, 2, mean)

all.onco.mean <- apply(all_onco_prism, 2, mean)

onco.mean <- apply(onco_prism, 2, mean)

prism.mean <- apply(prism_lowest, 2, mean)

non.onco.var <- apply(non_onco_prism, 2, var)

onco.var <- apply(onco_prism, 2, var)

mean(onco.var)
mean(non.onco.var)

hist(onco.mean)
hist(all.onco.mean)
hist(non.onco.mean)
hist(prism.mean)

shapiro.test(onco.mean)
shapiro.test(all.onco.mean)
shapiro.test(non.onco.mean)
shapiro.test(prism.mean)

#All of those variables are not normally distributed. This means we have to use a non-parametric test.

```
```{r}
#alpha is equal to 5%
wilcox.test(all.onco.mean, non.onco.mean) #p-value = 0.6546
wilcox.test(onco.mean, non.onco.mean) #p-value = 0.3249 
wilcox.test(onco.mean, prism.mean) #p-value = 0.322

#This means that the means are not significantly different.

```



trying to calculate the correlation between treatment response and gene expression. I'm very unsure if this will work in any way but here we go...

```{r}
##Run this code once, trust me it will take a while...

exp.treat.cor <- data.frame()  

for (y in 1:ncol(breast_prism_lowest)) {
  correlation <- c()
  
  for (x in 1:ncol(breast_PRISM.exp)) {
    gene.expression <- breast_PRISM.exp[, x]
    correlation[x] <- cor(breast_prism_lowest[, y], gene.expression)
  }
  
  
  
  if (y == 1) {
    exp.treat.cor <- correlation  
  } else {
    exp.treat.cor <- cbind(exp.treat.cor, correlation)  
  }
}
colnames(exp.treat.cor) <- colnames(breast_prism_lowest)
rownames(exp.treat.cor) <- colnames(breast_PRISM.exp)
```






```{r}

for (y in 1:ncol(breast_prism_lowest)) {
  correlation <- c()
  
  for (x in 1:100) {
    gene.expression <- breast_PRISM.exp[, x]
    correlation[x] <- cor(breast_prism_lowest[, y], gene.expression)
  }
  
  
  
  if (y == 1) {
    test.exp.treat.cor <- correlation  
  } else {
    test.exp.treat.cor <- cbind(test.exp.treat.cor, correlation)  
  }
}
```

Finding out which gene has a high absolute correlation with the treatment response.


```{r}
abs.exp.treat.cor <- abs(exp.treat.cor)
cor.test <- apply(abs.exp.treat.cor, 2, function(x){
  sum(0.75<x)
  
}) #0.75 is the mean and median of the maximum absolute correlations 



```

Testing if the correlation also means that there is a signifikant difference between the means of the treatment response in comparison to all the other treatment responses.
```{r}
rel.genes <- list()

for (i in 1:ncol(abs.exp.treat.cor)) {
  cor.genes <- rownames(abs.exp.treat.cor)[which(abs.exp.treat.cor[, i] > 0.75)]
  rel.genes[[i]] <- cor.genes
  
}
names(rel.genes) <- colnames(abs.exp.treat.cor)
all.rel.genes <- rel.genes
for (k in 1:length(rel.genes)){
  targets.position <- which(treat.gene_list$`rownames(prism.treat)`%in%names(rel.genes)[k])
  targets <- treat.gene_list$target[targets.position]
  all.rel.genes[[k]] <- append(all.rel.genes[[k]], targets)
}
```

Now we investigate which genes appear the most often in all.rel.genes

```{r}
test
```



```{r}
#Correlation between copy number and gene expression
row.order <- c() 
for (i in 1:nrow(breast_prism.cnv)){
  row.order <- rbind(row.order, which(rownames(breast_prism.cnv)%in%rownames(breast_PRISM.exp)[i]))
  }
#order of rows in the two data frames are not the same
exp.copy.cor <- data.frame()
copy.names <- c()
for (x in 1:ncol(breast_PRISM.exp)){
  copy.gene <- which(colnames(breast_prism.cnv)%in%colnames(breast_PRISM.exp)[x])
  if (length(copy.gene) > 0) {
    copy.cor <- cor(breast_PRISM.exp[,x], breast_prism.cnv[row.order,copy.gene])
    exp.copy.cor <- rbind(exp.copy.cor, copy.cor)
    copy.names <- c(copy.names, rownames(breast_PRISM.exp)[x])
  }
}

```




```{r}
#achilles mean tests

breast_achilles_mean <- apply(prism.achilles.breast, 2, mean)
prism.achilles.other <-prism.achilles.rm[-which(rownames(prism.achilles.rm) %in% prism.cl[breast.cl, 1]), ]
other_achilles_mean <- apply(prism.achilles.other, 2, mean)

#achilles.mean.test <- apply(prism.achilles.breast, 2, function(x)
achilles.genes <- c() 
for(x in 1:ncol(prism.achilles.breast))  {
  achilles.genes <- rbind(achilles.genes, wilcox.test(prism.achilles.breast[,x], prism.achilles.other[,x]))
  
}
rownames(achilles.genes) <- colnames(prism.achilles)
achilles.test.genes <- which(achilles.genes[,3]<0.01)



breast_achilles_relmeans <- apply(prism.achilles.breast[,achilles.test.genes], 2, mean)

achilles.low.score <- which(breast_achilles_relmeans < other_achilles_mean[achilles.test.genes])

achilles.rel.genes <- which(breast_achilles_relmeans[achilles.low.score] < -1)


print(achilles.rel.genes)
```


```{r}
#junkyard


```


